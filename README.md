#### 一、BMS系统如何工作

##### 1. 锂电池的特性

###### 1）充电/放电特性

- 充电特性：采用CC-CV（恒流-恒压）充电方式，初始阶段以恒定电流充电，电压逐渐上升；当达到设定电压后转为恒压充电，电流逐渐减小。

- 放电特性：放电初期电压下降较快，随后进入稳定放电平台期（电压变化小），末期电压急剧下降形成"截止点"。

- 保护机制：

  - 过充保护点：电压监测到上限值（如4.2V）立即停止充电

  - 过放保护点：放电至电压下限值（如3.0V）停止放电

- 形象比喻：如同倒水瓶，初始倾倒容易（放电快），随着水量减少压力降低（电压下降），最后无法完全倒净（剩余电量）。

###### 2）单节锂电池的电特性参数值

- 过压保护与恢复电压

  - 过压保护(OV_PROTECT)：

    对应充电曲线顶点，超过此值可能损坏电池。

  - 过压恢复(OV_RELIEVE)：

    电量从饱和状态下降0.02V即视为退出过压状态。

  - 设置原理：类似手机电量显示从100%→99%的临界点，需确保系统能稳定识别状态切换。

- 欠压保护与恢复电压

  - 欠压保护(UV_PROTECT)：

    ﻿放电截止电压，低于此值继续放电将损伤电池。

  - 欠压恢复(UV_RELIEVE)：

    ﻿充电至此电压视为退出欠压状态。

  - 动态特性：放电时电压呈阶梯式下降，末期电压下降速度显著加快。

- 自动关机电压

  - 关机电压(SHUTDOWN_VOLTAGE)：

    ﻿比欠压保护更低的安全阈值。

  - 类比说明：如同手机在3%电量报警后，继续使用至自动关机的保护机制。

- 均衡起始电压

  - 均衡电压(BALANCE_VOLTAGE)：

    ﻿仅当电池电压高于此值时才启用均衡功能。

  - 设计考量：避免在低电量时进行无效均衡，保护电池健康状态。

3）电池管理系统(BMS)核心功能

- 状态监控：实时监测电池剩余电量(SOC)和健康度(SOH)等关键参数

- 均衡管理：实现充电/放电时的主动/被动均衡功能

- 外部对接：支持与充电桩的通信协议和快充标准对接

4）锂电池类型对比

  三元锂：能量密度高（续航长）、耐低温但安全性差；

  磷酸铁锂：安全性好、成本低但低温衰减严重。

##### 5）BMS系统相关核心技术

  ###### 电芯参数监测、充放电开关控制、软硬件保护逻辑等

- 监测实现：使用高精度ADC采样电芯电压和电阻参数，通过专用模拟前端芯片(AFE)如BQ76920实现

- 开关控制：采用MOSFET管实现充放电通断控制，由嵌入式软件控制其开关状态

- 保护机制：包含过充保护、过放保护、过温保护等多重软硬件保护措施

- 硬件架构：典型方案为STM32F103主控+BQ76920模拟前端芯片组合

###### 6）电能相关参数SOX的计算

- 核心参数：包含SOC(剩余电量)、SOH(健康度)等以SO开头的电能参数

- 实现方式：

  - 理论层：通过Matlab/Simulink建立电池模型和算法

  - 应用层：在嵌入式平台实现算法落地

- 技术演进：可采用AI算法通过大量实际数据训练提升计算精度

- 项目特点：本案例采用常规算法实现，重点在于嵌入式落地而非算法创新

###### 7）数据通信和监控业务逻辑

- 通信架构：

  - 分布式BMS采用CAN总线连接BMU与CMU单元

  - 一体式BMS内部通信相对简单

- 业务实现：包含数据协议定义、服务化封装(SOA)等上层应用逻辑

- 项目特点：本案例实现基础通信功能，主要作为技术占位展示




##### 二、BMS业务逻辑层次

- 层次划分：系统分为三个逻辑层次

  - 底层（修路层）：负责硬件通道管理（如I2C通信初始化）

  - 中间层（物流层）：实现数据传输与协议处理

  - 上层（业务层）：执行具体业务功能（如电池监控、保护等）

- 核心思想：底层是手段，上层是目的，所有技术实现最终服务于业务需求

- 业务组成：系统包含6大核心业务模块

  - 电池监控业务(BMS_Monitor)

  - 电池保护业务(BMS_Protect)

  - 电池分析业务(BMS_Analysis)

  - 能量管理业务(BMS_Energy)

  - 信息管理业务(BMS_Info)

  - 通信管理业务(BMS_Comm)

2）电池监控任务分析

- MonitorBattery：负责电池相关参数的监控

  - 监控单体电芯电压，通过Bms_HalMonitorCellVoltage实现

  - 监控电池组电压，通过Bms_HalMonitorBatteryVoltage实现

    - 实现方式：通过I2C通信从BQ769X0芯片采集各电芯电压数据，更新数值后通过for循环遍历所有电芯，将原始数据存入BMS_MonitorData结构体

    - 硬件交互层:

      - 通过I2C总线与BQ769X0芯片通信

      - 使用BQ769X0_ReadBlockWithCRC带CRC校验读取数据块

      - 原始ADC数据需进行位移和运算处理

    - 驱动分层

      - 上层驱动：BQ769X0芯片功能封装

      - 下层驱动：软件模拟I2C通信（基于GPIO操作）

  - 监控电池温度：通过Bms_HalMonitorCellTemperature实现

    - 实现方式：同样通过BQ769X0芯片获取原始数据，温度数据存储在BMS_MonitorData.CellTemp数组中

  - 监控电池电流，通过Bms_HalMonitorBatteryCurrent实现

- MonitorSysMode：负责系统运行模式的监控

  - 功能定位：通过电流监测实现BMS系统状态（sleep/standby/工作模式）的自动转换

  - 实现方式：周期性检查电池电流值，根据阈值判断当前系统应处的模式状态

- 执行特点：属于高频执行任务，需要周期性采集数据

3）电池保护任务分析

- 软件保护实现机制：周期性检测（约1秒），存在延迟

  - 充电保护类型：

    - 过流(OCC)：BatteryCurrent > OCCProtect

    - 过温(OTC)：CellTemp > OTCProtect

    - 低温(LTC)：CellTemp < LTCProtect

    - 处理流程：

      - 调用BMS_HalCtrlCharge(BMS_STATE_DISABLE)停止充电

      - 启动定时器BMS_ProtectStartTimer设置恢复等待时间

      - 更新状态标志ProtectState和BMS_ProtectAlert

  - 放电保护：

    - 主要监控：温度异常（过温/低温）

    - 关键操作：通过BMS_HalCtrlDischarge控制放电MOSFET

- 硬件保护机制

  - 保护类型：立即触发，用于短路等紧急情况

    - OCD：放电过流保护

    - SCD：短路保护

    - OV/UV：过压/欠压保护

  - 处理特点：

    - 硬件自动触发保护动作

    - 软件主要负责状态记录和延时恢复

    - 通过BMS_ProtectStartTimer设置不同的恢复时间：

      - OCDRelieve：放电过流恢复时间

      - SCDRelieve：短路恢复时间

    - 解除操作：

      - 充电相关保护：调用BMS_HalCtrlCharge重新使能充电

      - 放电相关保护：调用BMS_HalCtrlDischarge恢复放电

4) RTOS任务设计好处

  - 简化业务逻辑设计；Monitor与Protect任务独立运行，通过全局变量实现数据共享

  - 任务间解耦，各自专注单一功能；优先级设置与临界区保护

5）电池分析任务-分析内容

  - 最大电压差：通过已排序的电池电压数据计算最高与最低电压差值

  - 平均电压：对所有电池电压求和后取平均

  - 实时功率：通过电流和电压相乘直接计算得到

  - 特点：这些参数都是通过简单计算即可获得，不需要复杂算法

  - 实时校准容量-影响因素

    - 温度变化对电池容量的影响

    - 完整充放电循环次数

    - 电池老化程度

    - 实现方式：通过BMS_AnalysisTempCal()函数进行温度校准

    - 温度校准

      - 温度变化检测：判断当前温度与上次记录温度差值是否超过1度

      - 校准比率计算：根据温度变化范围确定容量调整比率

      - 应用场景：特别在低温环境下，锂电池容量会显著减少，需要进行补偿

  - SOC检查与计算

  - 调用BMS_AnalysisOcvSocCalculate()进行开路电压到SOC的转换

  - 调用BMS_AnalysisAHSocCalculate()进行安时积分计算

6）能量管理任务

  - 信号量作用

    - 同步机制：使用信号量实现任务间同步，当条件成熟时通过信号量唤醒等待任务

    - 均衡控制：信号量专门用于均衡管理，防止多任务同时操作均衡状态

    - 工作流程：任务可能沉睡在信号量上，另一任务发出信号量激活同步

  - 充放电管理

    - 报警处理：仅在BMS_ProtectAlert == FLAG_ALERT_NO时执行充放电操作 

    - SOC控制： 充电停止：当SOC ≥ SocStopChg时调用BMS_HalCtrlCharge

    - 放电停止：当SOC ≤ SocStopDsg时关闭放电 

    - 安全设计：SOC阈值设置需留余量（如物理100%对应逻辑120%） 

    - 模式切换： 

    - 待机模式：检查用户开关状态(BMS_GlobalParam.Charge/Discharge) 

    - 睡眠模式：特殊情况下允许充电底层调用，最终通过BQ769X0_ControlDSGOrCHG控制MOS管 

    - 命令响应：周期性检查全局参数变化实现命令快速响应

  - 均衡管理

    - 触发条件：

      - 需同时满足BalanceFlagfalse且BMS_GlobalParam.BalanceBMS_STATE_ENABLE 

      - 电压回升：设置BalanceVoltRiseTime防止充放电后立即均衡 

      - 硬件操作： 通过BMS_HalCtrlCellsBalance控制具体电芯均衡使用BMS_BalanceStartTimer设置均衡持续时间 

      - 周期控制：BalanceCycleTime配置单次均衡时长（如5秒或5分钟）

      - 芯片封装：调用BQ769X0_CellBalanceControl实现硬件级均衡 

      - 寄存器操作：通过I2C修改CELL_BAL_VALUE寄存器组（3字节位图控制32节电芯）

  7)信息管理业务

    - 功能定位：信息管理业务属于BMS系统的应用层功能模块，主要负责电池状态信息的格式化输出

  8)通信管理业务

    - 功能定位：处理BMS系统与外部设备的通信交互，包括CAN总线、485等通信协议

  

  

      



